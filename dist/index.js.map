{"version":3,"file":"index.js","sources":["../src/index.js"],"sourcesContent":["const electron = require('@electron/remote')\nconst readChunk = require('read-chunk')\nconst got = require('got')\nconst path = require('path')\n\nconst { BrowserWindow } = electron\n\nconst PDF_VIEWER_PATH = path.join(__dirname, '../viewer/web/viewer.html')\n\nfunction isAlreadyLoadedWithPdfJs(url) {\n  return url.startsWith(`file://${PDFWindow.viewerPath}?file=`)\n}\n\nfunction isFile(url) {\n  return url.match(/^file:\\/\\//i)\n}\n\nfunction isPDFMime(url) {\n  const filePath = url.replace(/^file:\\/\\//i, '')\n  const buffer = readChunk.sync(filePath, 0, 262)\n\n  return buffer[0] === 0x25 && buffer[1] === 0x50 && buffer[2] === 0x44 && buffer[3] === 0x46\n}\n\nfunction hasPdfExtension(url) {\n  return url.match(/\\.pdf$/i)\n}\n\nconst isPDF = asyncWrapper(url => {\n  return new Promise(async (resolve, reject) => {\n    if (isAlreadyLoadedWithPdfJs(url)) {\n      resolve(false)\n    } else if (isFile(url)) {\n      resolve(isPDFMime(url))\n    } else if (hasPdfExtension(url)) {\n      resolve(true)\n    } else {\n      const [err, res] = await asyncWrapper(got.head)(url)\n      if (err) reject(err)\n      const { headers } = res\n      if (headers.location) {\n        const [err, isIt] = await isPDF(headers.location)\n        if (err) reject(err)\n        resolve(isIt)\n      }\n      resolve(res.headers['content-type'].includes('application/pdf'))\n    }\n  })\n})\n\nfunction asyncWrapper(fn) {\n  return async (...args) => {\n    try {\n      const res = await fn.call(this, ...args)\n      return [null, res]\n    } catch (err) {\n      return [err, null]\n    }\n  }\n}\n\nclass PDFWindow extends BrowserWindow {\n  constructor(options) {\n    super(options)\n  }\n\n  static viewerPath = PDF_VIEWER_PATH\n\n  static addSupport(browserWindow) {\n    const { loadURL } = browserWindow\n    browserWindow.loadURL = async (url, options) => {\n      const [err, isIt] = await isPDF(url)\n      if (err || !isIt) {\n        loadURL.call(browserWindow, url, options)\n        return\n      }\n\n      loadURL.call(\n        browserWindow,\n        `file://${PDFWindow.viewerPath}?file=${decodeURIComponent(url)}`,\n        options\n      )\n    }\n  }\n\n  async loadURL(url, options) {\n    const [err, isIt] = await isPDF(url)\n    if (err || !isIt) {\n      super.loadURL(url, options)\n      return\n    }\n\n    super.loadURL(`file://${PDFWindow.viewerPath}?file=${decodeURIComponent(url)}`, options)\n  }\n}\n\nexport default PDFWindow\n"],"names":[],"mappings":"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"}